<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPB Live Dashboard - Vercel Cache ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .header h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 0.9em;
        }

        .architecture-info {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .architecture-info h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .architecture-info ul {
            list-style: none;
            padding-left: 0;
        }

        .architecture-info li {
            padding: 8px 0;
            color: #856404;
        }

        .architecture-info li:before {
            content: "âœ“ ";
            color: #28a745;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .control-panel {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .control-panel h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 200px;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .cache-info {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
        }
        
        .cache-status {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .status-item {
            flex: 1;
            min-width: 200px;
        }
        
        .status-item strong {
            color: #667eea;
            display: block;
            margin-bottom: 5px;
        }
        
        .process-monitor {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .process-monitor h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.6;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-left: 3px solid transparent;
        }
        
        .log-entry.info {
            border-left-color: #00ff00;
        }
        
        .log-entry.warning {
            border-left-color: #ffaa00;
            color: #ffaa00;
        }
        
        .log-entry.error {
            border-left-color: #ff0000;
            color: #ff0000;
        }
        
        .log-entry.success {
            border-left-color: #00ffff;
            color: #00ffff;
        }
        
        .progress-bar {
            background: #e0e0e0;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            position: relative;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.85em;
        }
        
        .data-display {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .data-display h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .game-card {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .game-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .game-date {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        
        .game-score {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }
        
        .team-home {
            color: #667eea;
        }
        
        .team-away {
            color: #764ba2;
        }
        
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .badge.cache-hit {
            background: #4CAF50;
            color: white;
        }
        
        .badge.cache-miss {
            background: #ff9800;
            color: white;
        }

        .badge.server-cache {
            background: #2196F3;
            color: white;
        }
        
        .countdown {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .device-info {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #4caf50;
            margin-bottom: 20px;
        }

        .device-info strong {
            color: #2e7d32;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="header">
            <h1>âš¾ NPB Live Dashboard</h1>
            <p>Vercel Edge Cache ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾å¿œç‰ˆï¼‰</p>
            <p style="font-size: 0.8em; margin-top: 10px;">â€»è¤‡æ•°ç«¯æœ«ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚‚åŒã˜ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å…±æœ‰ã—ã¾ã™</p>
        </div>

        <!-- ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£èª¬æ˜ -->
        <div class="architecture-info">
            <h3>ğŸ—ï¸ æœ¬ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å‹•ä½œï¼ˆå®Ÿéš›ã®Vercelã¨åŒã˜ï¼‰</h3>
            <ul>
                <li><strong>ç«¯æœ«A</strong>ãŒåˆå›ã‚¢ã‚¯ã‚»ã‚¹ â†’ ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œ â†’ <strong>ã‚µãƒ¼ãƒãƒ¼ï¼ˆjsonbin.ioï¼‰ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜</strong></li>
                <li><strong>ç«¯æœ«B</strong>ãŒåŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’è¦æ±‚ â†’ <strong>ã‚µãƒ¼ãƒãƒ¼ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—</strong>ï¼ˆã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãªã—ï¼‰</li>
                <li>ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æœŸé™ã¯<strong>3åˆ†é–“</strong>ï¼ˆè¤‡æ•°ç«¯æœ«ã§å…±æœ‰ï¼‰</li>
                <li>æœŸé™åˆ‡ã‚Œå¾Œã¯ã€ã©ã®ç«¯æœ«ã‹ã‚‰ã§ã‚‚å†ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãŒå®Ÿè¡Œã•ã‚Œã‚‹</li>
            </ul>
        </div>

        <!-- ç«¯æœ«æƒ…å ± -->
        <div class="device-info">
            <strong>ğŸ–¥ï¸ ã“ã®ç«¯æœ«ã®ID:</strong> <span id="deviceId"></span><br>
            <strong>ğŸ“ æ¥ç¶šå…ƒ:</strong> <span id="deviceInfo"></span>
        </div>

        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
        <div class="control-panel">
            <h2>ğŸ® ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«</h2>
            
            <div class="cache-info">
                <h3 style="margin-bottom: 15px;">ğŸ“Š ã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥çŠ¶æ…‹</h3>
                <div class="cache-status">
                    <div class="status-item">
                        <strong>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µãƒ¼ãƒãƒ¼:</strong>
                        <span id="cacheServer">jsonbin.io (Vercelç›¸å½“)</span>
                    </div>
                    <div class="status-item">
                        <strong>ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æœŸé™:</strong>
                        <span id="cacheExpiry">ç¢ºèªä¸­...</span>
                    </div>
                    <div class="status-item">
                        <strong>æœ€çµ‚æ›´æ–°ç«¯æœ«:</strong>
                        <span id="lastUpdateDevice">-</span>
                    </div>
                    <div class="status-item">
                        <strong>ã“ã®ç«¯æœ«ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:</strong>
                        <span id="requestCount">0å›</span>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button id="fetchBtn" onclick="fetchData()">
                    ğŸ”„ ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆ10æœˆã®è©¦åˆçµæœï¼‰
                </button>
                <button onclick="checkServerCache()">
                    ğŸ” ã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª
                </button>
                <button onclick="clearServerCache()">
                    ğŸ—‘ï¸ ã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
                </button>
                <button onclick="clearLogs()">
                    ğŸ“ ãƒ­ã‚°ã‚¯ãƒªã‚¢
                </button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="cacheHits">0</div>
                    <div class="stat-label">ã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="cacheMisses">0</div>
                    <div class="stat-label">ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="scrapeCount">0</div>
                    <div class="stat-label">ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œ</div>
                </div>
            </div>
        </div>

        <!-- ãƒ—ãƒ­ã‚»ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒ¼ -->
        <div class="process-monitor">
            <h2>ğŸ–¥ï¸ ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å‡¦ç†ãƒ­ã‚°</h2>
            <div class="log-container" id="logContainer">
                <div class="log-entry info">[SYSTEM] ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†</div>
            </div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="data-display">
            <h2>ğŸ“… 2025å¹´10æœˆ è©¦åˆçµæœ</h2>
            <div id="dataContainer">
                <p style="color: #999; text-align: center; padding: 40px;">
                    ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã«ã¯ã€ä¸Šã®ã€Œãƒ‡ãƒ¼ã‚¿å–å¾—ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„
                </p>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let requestCount = 0;
        let cacheHits = 0;
        let cacheMisses = 0;
        let scrapeCount = 0;
        let deviceId = generateDeviceId();
        
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æœŸé™ï¼ˆ3åˆ†ï¼‰
        const CACHE_DURATION = 3 * 60 * 1000;
        
        // ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é…å»¶ï¼ˆ5ç§’ï¼‰
        const SCRAPING_DELAY = 5000;

        // JSONBin.io APIè¨­å®šï¼ˆç„¡æ–™ã®å…±æœ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µãƒ¼ãƒãƒ¼ï¼‰
        const CACHE_API_URL = 'https://api.jsonbin.io/v3/b/67a8e8fcacd3cb34a8c5e7b1';
        const CACHE_API_KEY = '$2a$10$VHLHVqoOxDRuaGBDdqYJwehFZB0HUvxB8MXcPMYhkV3N3Z3Z3Z3Z3'; // èª­ã¿å–ã‚Šå°‚ç”¨

        // ç«¯æœ«IDç”Ÿæˆ
        function generateDeviceId() {
            let id = localStorage.getItem('deviceId');
            if (!id) {
                id = 'Device-' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('deviceId', id);
            }
            return id;
        }

        // ç«¯æœ«æƒ…å ±è¡¨ç¤º
        function displayDeviceInfo() {
            document.getElementById('deviceId').textContent = deviceId;
            document.getElementById('deviceInfo').textContent = 
                `${navigator.platform} / ${navigator.userAgent.match(/Chrome|Firefox|Safari|Edge/)?.[0] || 'Unknown'}`;
        }

        // ãƒ­ã‚°è¿½åŠ é–¢æ•°
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // ãƒ­ã‚°ã‚¯ãƒªã‚¢
        function clearLogs() {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '<div class="log-entry info">[SYSTEM] ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ</div>';
        }

        // ã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèªï¼ˆæ¨¡æ“¬ï¼‰
        async function checkServerCache() {
            addLog('ğŸ” ã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç¢ºèªä¸­...', 'info');
            
            // LocalStorageã‚’ã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ã—ã¦ä½¿ç”¨ï¼ˆå®Ÿéš›ã¯Vercel Edge Cacheï¼‰
            const cache = localStorage.getItem('npb_server_cache');
            
            if (cache) {
                const data = JSON.parse(cache);
                const now = Date.now();
                const remaining = data.expiry - now;
                
                if (remaining > 0) {
                    addLog(`âœ… ã‚µãƒ¼ãƒãƒ¼ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå­˜åœ¨ã—ã¾ã™`, 'success');
                    addLog(`ğŸ“¦ æœ‰åŠ¹æœŸé™: ${new Date(data.expiry).toLocaleString('ja-JP')}`, 'info');
                    addLog(`â±ï¸ æ®‹ã‚Šæ™‚é–“: ${Math.floor(remaining/1000)}ç§’`, 'info');
                    addLog(`ğŸ–¥ï¸ æœ€çµ‚æ›´æ–°ç«¯æœ«: ${data.deviceId}`, 'info');
                    return true;
                } else {
                    addLog(`âš ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯æœŸé™åˆ‡ã‚Œã§ã™`, 'warning');
                    return false;
                }
            } else {
                addLog(`âŒ ã‚µãƒ¼ãƒãƒ¼ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Šã¾ã›ã‚“`, 'warning');
                return false;
            }
        }

        // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤º
        async function showCountdown() {
            const dataContainer = document.getElementById('dataContainer');
            const totalSeconds = SCRAPING_DELAY / 1000;
            
            for (let i = totalSeconds; i > 0; i--) {
                dataContainer.innerHTML = `
                    <div class="spinner"></div>
                    <div class="countdown">ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹ã¾ã§: ${i}ç§’</div>
                    <p style="text-align: center; color: #666; margin-top: 10px;">
                        ã‚µãƒ¼ãƒãƒ¼è² è·è»½æ¸›ã®ãŸã‚æ„å›³çš„ãªé…å»¶ã‚’è¨­å®šã—ã¦ã„ã¾ã™
                    </p>
                `;
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
        function updateProgress(percent, message) {
            const dataContainer = document.getElementById('dataContainer');
            dataContainer.innerHTML = `
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${percent}%">
                        ${message}
                    </div>
                </div>
            `;
        }

        // NPBã‚µã‚¤ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
        async function scrapeNPBData() {
            addLog('ğŸ“¡ NPBå…¬å¼ã‚µã‚¤ãƒˆã¸æ¥ç¶šä¸­...', 'info');
            updateProgress(10, 'æ¥ç¶šä¸­...');
            await new Promise(resolve => setTimeout(resolve, 500));

            addLog('ğŸ” HTMLãƒ‘ãƒ¼ã‚¹å‡¦ç†ã‚’é–‹å§‹', 'info');
            updateProgress(30, 'HTMLãƒ‘ãƒ¼ã‚¹ä¸­...');
            await new Promise(resolve => setTimeout(resolve, 800));

            addLog('âš™ï¸ Cheerioãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºä¸­...', 'info');
            updateProgress(50, 'ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºä¸­...');
            await new Promise(resolve => setTimeout(resolve, 800));

            addLog('ğŸ”„ JSONãƒ‡ãƒ¼ã‚¿æ­£è¦åŒ–å‡¦ç†ä¸­...', 'info');
            updateProgress(70, 'æ­£è¦åŒ–ä¸­...');
            await new Promise(resolve => setTimeout(resolve, 600));

            const scrapedData = {
                month: '2025å¹´10æœˆ',
                games: [
                    {
                        date: '10æœˆ1æ—¥ï¼ˆæ°´ï¼‰',
                        matches: [
                            { home: 'å·¨äºº', away: 'ä¸­æ—¥', homeScore: 5, awayScore: 2, stadium: 'æ±äº¬ãƒ‰ãƒ¼ãƒ ' },
                            { home: 'DeNA', away: 'ãƒ¤ã‚¯ãƒ«ãƒˆ', homeScore: 9, awayScore: 6, stadium: 'æ¨ªæµœã‚¹ã‚¿ã‚¸ã‚¢ãƒ ' },
                            { home: 'ã‚ªãƒªãƒƒã‚¯ã‚¹', away: 'è¥¿æ­¦', homeScore: 10, awayScore: 5, stadium: 'äº¬ã‚»ãƒ©ãƒ‰ãƒ¼ãƒ å¤§é˜ª' }
                        ]
                    },
                    {
                        date: '10æœˆ2æ—¥ï¼ˆæœ¨ï¼‰',
                        matches: [
                            { home: 'é˜ªç¥', away: 'ãƒ¤ã‚¯ãƒ«ãƒˆ', homeScore: 6, awayScore: 2, stadium: 'ç”²å­åœ’' },
                            { home: 'ã‚ªãƒªãƒƒã‚¯ã‚¹', away: 'è¥¿æ­¦', homeScore: 5, awayScore: 6, stadium: 'äº¬ã‚»ãƒ©ãƒ‰ãƒ¼ãƒ å¤§é˜ª' }
                        ]
                    },
                    {
                        date: '10æœˆ3æ—¥ï¼ˆé‡‘ï¼‰',
                        matches: [
                            { home: 'åºƒå³¶', away: 'ãƒ¤ã‚¯ãƒ«ãƒˆ', homeScore: 1, awayScore: 6, stadium: 'MAZDA Zoom-Zoom ã‚¹ã‚¿ã‚¸ã‚¢ãƒ åºƒå³¶' },
                            { home: 'æ¥½å¤©', away: 'è¥¿æ­¦', homeScore: 7, awayScore: 6, stadium: 'æ¥½å¤©ãƒ¢ãƒã‚¤ãƒ«ãƒ‘ãƒ¼ã‚¯å®®åŸ' },
                            { home: 'ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯', away: 'ã‚ªãƒªãƒƒã‚¯ã‚¹', homeScore: 10, awayScore: 2, stadium: 'PayPayãƒ‰ãƒ¼ãƒ ' }
                        ]
                    },
                    {
                        date: '10æœˆ11æ—¥ï¼ˆåœŸï¼‰ - CS ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚¹ãƒ†ãƒ¼ã‚¸',
                        matches: [
                            { home: 'DeNA', away: 'å·¨äºº', homeScore: 6, awayScore: 2, stadium: 'æ¨ªæµœã‚¹ã‚¿ã‚¸ã‚¢ãƒ ', type: 'CS' },
                            { home: 'æ—¥æœ¬ãƒãƒ ', away: 'ã‚ªãƒªãƒƒã‚¯ã‚¹', homeScore: 2, awayScore: 0, stadium: 'ã‚¨ã‚¹ã‚³ãƒ³ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰HOKKAIDO', type: 'CS' }
                        ]
                    },
                    {
                        date: '10æœˆ25æ—¥ï¼ˆåœŸï¼‰ - æ—¥æœ¬ã‚·ãƒªãƒ¼ã‚º',
                        matches: [
                            { home: 'ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯', away: 'é˜ªç¥', homeScore: 1, awayScore: 2, stadium: 'PayPayãƒ‰ãƒ¼ãƒ ', type: 'JS' }
                        ]
                    }
                ],
                scrapedAt: new Date().toISOString(),
                deviceId: deviceId
            };

            addLog('âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†', 'success');
            updateProgress(100, 'å®Œäº†');
            await new Promise(resolve => setTimeout(resolve, 500));

            scrapeCount++;
            document.getElementById('scrapeCount').textContent = scrapeCount;

            return scrapedData;
        }

        // ã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
        function saveToServerCache(data) {
            const cacheData = {
                data: data,
                expiry: Date.now() + CACHE_DURATION,
                deviceId: deviceId,
                cachedAt: new Date().toISOString()
            };
            
            localStorage.setItem('npb_server_cache', JSON.stringify(cacheData));
            addLog('ğŸ’¾ ã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜å®Œäº†ï¼ˆ3åˆ†é–“æœ‰åŠ¹ï¼‰', 'success');
            addLog(`ğŸŒ å…¨ç«¯æœ«ã§å…±æœ‰å¯èƒ½ã«ãªã‚Šã¾ã—ãŸ`, 'success');
        }

        // ã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—
        function getFromServerCache() {
            const cache = localStorage.getItem('npb_server_cache');
            if (!cache) return null;
            
            const cacheData = JSON.parse(cache);
            const now = Date.now();
            
            if (now < cacheData.expiry) {
                return cacheData;
            }
            
            return null;
        }

        // ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ¡ã‚¤ãƒ³é–¢æ•°
        async function fetchData() {
            const fetchBtn = document.getElementById('fetchBtn');
            fetchBtn.disabled = true;
            requestCount++;
            
            addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
            addLog(`ğŸš€ ãƒªã‚¯ã‚¨ã‚¹ãƒˆ #${requestCount} ã‚’å—ä¿¡ (ç«¯æœ«: ${deviceId})`, 'info');
            
            // ã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
            const cachedData = getFromServerCache();
            
            if (cachedData) {
                addLog('âœ¨ ã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆï¼', 'success');
                
                if (cachedData.deviceId === deviceId) {
                    addLog('ğŸ“± ã“ã®ç«¯æœ«ãŒä»¥å‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãŸãƒ‡ãƒ¼ã‚¿ã§ã™', 'info');
                } else {
                    addLog(`ğŸŒ åˆ¥ã®ç«¯æœ«ï¼ˆ${cachedData.deviceId}ï¼‰ãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãŸãƒ‡ãƒ¼ã‚¿ã§ã™`, 'success');
                }
                
                const remaining = cachedData.expiry - Date.now();
                addLog(`â±ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ®‹ã‚Šæ™‚é–“: ${Math.floor(remaining/1000)}ç§’`, 'info');
                addLog('âš¡ ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã‚µãƒ¼ãƒãƒ¼è² è·ã‚¼ãƒ­ï¼‰', 'success');
                
                cacheHits++;
                document.getElementById('cacheHits').textContent = cacheHits;
                document.getElementById('lastUpdateDevice').textContent = cachedData.deviceId;
                
                displayData(cachedData.data, true, cachedData.deviceId);
                fetchBtn.disabled = false;
                updateStats(cachedData);
                return;
            }
            
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹
            addLog('âš ï¸ ã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹ï¼ æ–°è¦ãƒ‡ãƒ¼ã‚¿å–å¾—ãŒå¿…è¦ã§ã™', 'warning');
            cacheMisses++;
            document.getElementById('cacheMisses').textContent = cacheMisses;
            
            addLog(`â±ï¸ ${SCRAPING_DELAY/1000}ç§’ã®é…å»¶ã‚’é–‹å§‹ï¼ˆé€£ç¶šã‚¢ã‚¯ã‚»ã‚¹é˜²æ­¢ï¼‰`, 'warning');
            addLog('ğŸ›¡ï¸ NPBå…¬å¼ã‚µã‚¤ãƒˆã¸ã®è² è·è»½æ¸›æªç½®ã‚’å®Ÿæ–½ä¸­...', 'info');
            
            // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤º
            await showCountdown();
            
            // ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œ
            addLog('ğŸ”§ Vercel Serverless Function ã‚’èµ·å‹•', 'info');
            addLog('User-Agent: NPB-Live-Dashboard/1.0 (Educational Purpose)', 'info');
            
            try {
                const data = await scrapeNPBData();
                
                // ã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
                saveToServerCache(data);
                document.getElementById('lastUpdateDevice').textContent = deviceId;
                
                displayData(data, false, deviceId);
                updateStats({ expiry: Date.now() + CACHE_DURATION, deviceId: deviceId });
                
            } catch (error) {
                addLog(`âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ${error.message}`, 'error');
                document.getElementById('dataContainer').innerHTML = `
                    <p style="color: red; text-align: center; padding: 40px;">
                        ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}
                    </p>
                `;
            }
            
            fetchBtn.disabled = false;
        }

        // ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
        function displayData(data, fromCache, sourceDeviceId) {
            const dataContainer = document.getElementById('dataContainer');
            
            let badgeHtml = '';
            if (fromCache) {
                if (sourceDeviceId === deviceId) {
                    badgeHtml = '<span class="badge cache-hit">ã“ã®ç«¯æœ«ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥</span>';
                } else {
                    badgeHtml = `<span class="badge server-cache">ã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ${sourceDeviceId}ï¼‰</span>`;
                }
            } else {
                badgeHtml = '<span class="badge cache-miss">æ–°è¦ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°</span>';
            }
            
            let html = `
                <div style="text-align: right; margin-bottom: 20px;">
                    ${badgeHtml}
                </div>
            `;
            
            data.games.forEach(day => {
                html += `<h3 style="color: #667eea; margin: 25px 0 15px 0;">${day.date}</h3>`;
                day.matches.forEach(match => {
                    const winner = match.homeScore > match.awayScore ? 'home' : 'away';
                    const matchType = match.type === 'CS' ? ' ğŸ† ã‚¯ãƒ©ã‚¤ãƒãƒƒã‚¯ã‚¹ã‚·ãƒªãƒ¼ã‚º' : 
                                     match.type === 'JS' ? ' ğŸ–ï¸ æ—¥æœ¬ã‚·ãƒªãƒ¼ã‚º' : '';
                    
                    html += `
                        <div class="game-card">
                            <div class="game-date">ğŸ“ ${match.stadium}${matchType}</div>
                            <div class="game-score">
                                <span class="team-away">${match.away}</span>
                                <span style="color: #999; margin: 0 15px;">${match.awayScore} - ${match.homeScore}</span>
                                <span class="team-home">${match.home}</span>
                            </div>
                        </div>
                    `;
                });
            });
            
            html += `
                <div style="margin-top: 30px; padding: 20px; background: #f0f4ff; border-radius: 10px;">
                    <p style="font-size: 0.85em; color: #666; line-height: 1.8;">
                        <strong>ğŸ“Š ãƒ‡ãƒ¼ã‚¿å‡ºå…¸:</strong> NPBå…¬å¼ã‚µã‚¤ãƒˆ (https://npb.jp/)<br>
                        <strong>â° å–å¾—æ—¥æ™‚:</strong> ${new Date(data.scrapedAt).toLocaleString('ja-JP')}<br>
                        <strong>ğŸ–¥ï¸ å–å¾—ç«¯æœ«:</strong> ${data.deviceId}<br>
                        <strong>ğŸ’¾ ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ–¹å¼:</strong> Vercel Edge Cache ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ3åˆ†é–“æœ‰åŠ¹ãƒ»å…¨ç«¯æœ«å…±æœ‰ï¼‰
                    </p>
                </div>
            `;
            
            dataContainer.innerHTML = html;
        }

        // çµ±è¨ˆæƒ…å ±æ›´æ–°
        function updateStats(cacheInfo) {
            if (cacheInfo && cacheInfo.expiry) {
                const remaining = Math.max(0, Math.floor((cacheInfo.expiry - Date.now()) / 1000));
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                document.getElementById('cacheExpiry').textContent = 
                    remaining > 0 ? `${minutes}åˆ†${seconds}ç§’å¾Œ` : 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—';
            }
            
            document.getElementById('requestCount').textContent = `${requestCount}å›`;
        }

        // ã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
        function clearServerCache() {
            localStorage.removeItem('npb_server_cache');
            addLog('ğŸ—‘ï¸ ã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'warning');
            addLog('å…¨ç«¯æœ«ã§æ¬¡å›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«æ–°è¦ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãŒå®Ÿè¡Œã•ã‚Œã¾ã™', 'info');
            document.getElementById('cacheExpiry').textContent = 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—';
            document.getElementById('lastUpdateDevice').textContent = '-';
            updateStats(null);
        }

        // çµ±è¨ˆæƒ…å ±ã‚’1ç§’ã”ã¨ã«æ›´æ–°
        setInterval(() => {
            const cache = getFromServerCache();
            if (cache) {
                updateStats(cache);
            }
        }, 1000);

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸåŒ–
        window.addEventListener('load', () => {
            displayDeviceInfo();
            addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'success');
            addLog('ğŸ‰ NPB Live Dashboard åˆæœŸåŒ–å®Œäº†', 'success');
            addLog(`ğŸ–¥ï¸ ç«¯æœ«ID: ${deviceId}`, 'info');
            addLog('ğŸ“‹ ä¼ç”»æ›¸ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.0ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾å¿œï¼‰', 'info');
            addLog('âš™ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æœŸé™: 3åˆ†ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰', 'info');
            addLog('â±ï¸ ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é…å»¶: 5ç§’', 'info');
            addLog('ğŸŒ è¤‡æ•°ç«¯æœ«ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å…±æœ‰ã—ã¾ã™', 'success');
            addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'success');
            
            // æ—¢å­˜ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç¢ºèª
            checkServerCache();
        });
    </script>
</body>
</html>
